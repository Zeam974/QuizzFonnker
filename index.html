
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fonnk√®r ‚Äî Quiz de cl√¥ture</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<!-- Firebase SDK avec Authentication Google -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const ZEAM_UID = "3XwP4vczBcXXSbnBllCrEWVWsvF3";

  const firebaseConfig = {
    apiKey: "AIzaSyBKODKYxBpIo5mzKDV8T-Twbh-Ukg85I5w",
    authDomain: "fonnker-by-zeam.firebaseapp.com",
    databaseURL: "https://fonnker-by-zeam-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "fonnker-by-zeam",
    storageBucket: "fonnker-by-zeam.firebasestorage.app",
    messagingSenderId: "1008381298439",
    appId: "1:1008381298439:web:6349c4760da28a2be227a2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // ---- Exposition globale ----
  window._fbReady = true;
  window._zeamUID = ZEAM_UID;
  window._authUser = null;

  // ---- Connexion Google (r√©serv√©e Z√©am) ----
  window._connexionGoogle = async function() {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      if (user.uid !== ZEAM_UID) {
        await signOut(auth);
        window._authUser = null;
        alert("‚ùå Ce compte Google n'est pas autoris√©.");
        return false;
      }
      window._authUser = user;
      return true;
    } catch (e) {
      console.error('Erreur connexion Google:', e);
      return false;
    }
  };

  // ---- D√©connexion ----
  window._deconnexion = async function() {
    await signOut(auth);
    window._authUser = null;
  };

  // ---- Surveiller √©tat auth ----
  onAuthStateChanged(auth, (user) => {
    if (user && user.uid === ZEAM_UID) {
      window._authUser = user;
      // Mettre √† jour le dashboard si ouvert
      const dash = document.getElementById('screen-dashboard');
      if (dash && dash.classList.contains('active')) {
        if (typeof mettreAJourHeaderDash === 'function') mettreAJourHeaderDash();
      }
    } else {
      window._authUser = null;
    }
  });

  // ---- √âcoute temps r√©el dashboard (r√©serv√©e Z√©am authentifi√©e) ----
  window._startDashboardListener = function() {
    if (!window._authUser || window._authUser.uid !== ZEAM_UID) {
      console.warn('Acc√®s refus√© ‚Äî non authentifi√©');
      return;
    }
    const resultatsRef = ref(db, 'resultats');
    onValue(resultatsRef, (snapshot) => {
      const data = snapshot.val();
      const liste = data ? Object.entries(data).map(([id, val]) => ({ id, ...val })) : [];
      window._resultatsFirebase = liste;
      if (typeof afficherDashboard === 'function') afficherDashboard();
    });
  };

  // ---- √âcriture ouverte aux jeunes (anonyme) ----
  window._sauvegarderFirebase = function(entry) {
    const resultatsRef = ref(db, 'resultats');
    push(resultatsRef, entry).catch(e => console.error('Erreur √©criture:', e));
  };

  // ---- Suppression r√©serv√©e Z√©am ----
  window._resetFirebase = function() {
    if (!window._authUser || window._authUser.uid !== ZEAM_UID) {
      alert('‚õî Action r√©serv√©e √† Z√©am.');
      return;
    }
    const resultatsRef = ref(db, 'resultats');
    remove(resultatsRef).catch(e => console.error('Erreur suppression:', e));
  };

  console.log('‚úÖ Firebase Auth + DB connect√©s ‚Äî fonnker-by-zeam');
</script>
<style>
  :root {
    --orange: #E07B39;
    --orange-light: #F4A96A;
    --brun: #7A4A1E;
    --creme: #FDF6EC;
    --creme-dark: #F0E4D0;
    --noir: #1A1008;
    --gris: #8A7A6A;
    --vert: #4A7A5A;
    --feu: #D94F2A;
    --rose: #C4607A;
    --eclair: #7A5AB0;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--noir);
    color: var(--creme);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ========== FOND TEXTURE ========== */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse at 20% 20%, rgba(224,123,57,0.12) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 80%, rgba(122,74,30,0.15) 0%, transparent 50%),
      radial-gradient(ellipse at 50% 50%, rgba(26,16,8,1) 0%, #0D0804 100%);
    z-index: -1;
  }

  /* ========== √âCRANS ========== */
  .screen {
    display: none;
    min-height: 100vh;
    padding: 2rem 1.5rem;
    animation: fadeIn 0.5s ease;
  }
  .screen.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ========== LOGO / TITRE ========== */
  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 2.8rem;
    color: var(--orange);
    text-align: center;
    letter-spacing: -0.02em;
    line-height: 1;
  }
  .logo-sub {
    font-size: 0.85rem;
    color: var(--gris);
    text-align: center;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-top: 0.4rem;
  }
  .divider {
    width: 60px;
    height: 2px;
    background: var(--orange);
    margin: 1.5rem auto;
    border-radius: 2px;
  }

  /* ========== CARD ========== */
  .card {
    background: rgba(253,246,236,0.05);
    border: 1px solid rgba(224,123,57,0.2);
    border-radius: 20px;
    padding: 2rem;
    width: 100%;
    max-width: 480px;
    backdrop-filter: blur(10px);
  }

  /* ========== INPUTS ========== */
  .input-group { margin-bottom: 1.2rem; }
  .input-group label {
    display: block;
    font-size: 0.8rem;
    color: var(--orange-light);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }
  .input-group input {
    width: 100%;
    background: rgba(253,246,236,0.08);
    border: 1px solid rgba(224,123,57,0.3);
    border-radius: 10px;
    padding: 0.9rem 1.2rem;
    color: var(--creme);
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .input-group input:focus { border-color: var(--orange); }
  .input-group input::placeholder { color: var(--gris); }

  /* ========== BOUTONS ========== */
  .btn {
    background: var(--orange);
    color: var(--noir);
    border: none;
    border-radius: 50px;
    padding: 0.9rem 2.5rem;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    margin-top: 0.5rem;
  }
  .btn:hover { background: var(--orange-light); transform: translateY(-2px); }
  .btn:active { transform: translateY(0); }

  .btn-ghost {
    background: transparent;
    border: 1px solid rgba(224,123,57,0.4);
    color: var(--orange);
    border-radius: 50px;
    padding: 0.7rem 2rem;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-ghost:hover { background: rgba(224,123,57,0.1); }

  /* ========== PROGRESSION ========== */
  .progress-wrap {
    width: 100%;
    max-width: 480px;
    margin-bottom: 1.5rem;
  }
  .progress-info {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--gris);
    margin-bottom: 0.5rem;
  }
  .progress-bar {
    height: 3px;
    background: rgba(253,246,236,0.1);
    border-radius: 3px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: var(--orange);
    border-radius: 3px;
    transition: width 0.4s ease;
  }

  /* ========== QUESTION ========== */
  .question-number {
    font-size: 0.75rem;
    color: var(--orange);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 0.8rem;
  }
  .question-text {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    line-height: 1.5;
    color: var(--creme);
    margin-bottom: 1.8rem;
    max-width: 480px;
    text-align: center;
  }

  /* ========== OPTIONS ========== */
  .options {
    width: 100%;
    max-width: 480px;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }
  .option {
    background: rgba(253,246,236,0.05);
    border: 1px solid rgba(224,123,57,0.2);
    border-radius: 14px;
    padding: 1rem 1.3rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    text-align: left;
  }
  .option:hover {
    background: rgba(224,123,57,0.1);
    border-color: var(--orange);
    transform: translateX(4px);
  }
  .option.selected {
    background: rgba(224,123,57,0.2);
    border-color: var(--orange);
  }
  .option-letter {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(224,123,57,0.2);
    color: var(--orange);
    font-size: 0.8rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .option.selected .option-letter {
    background: var(--orange);
    color: var(--noir);
  }
  .option-text {
    font-size: 0.95rem;
    line-height: 1.5;
    color: var(--creme);
  }

  /* ========== PROFIL RESULT ========== */
  .profil-emoji {
    font-size: 4rem;
    margin-bottom: 0.5rem;
    display: block;
    text-align: center;
  }
  .profil-nom {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    color: var(--orange);
    text-align: center;
    margin-bottom: 0.5rem;
  }
  .profil-desc {
    font-size: 0.95rem;
    line-height: 1.7;
    color: var(--creme-dark);
    text-align: center;
    margin-bottom: 1rem;
  }
  .profil-force {
    background: rgba(224,123,57,0.1);
    border: 1px solid rgba(224,123,57,0.3);
    border-radius: 10px;
    padding: 0.8rem 1rem;
    font-size: 0.85rem;
    color: var(--orange-light);
    text-align: center;
    margin-bottom: 0.6rem;
  }
  .profil-etape {
    background: rgba(253,246,236,0.05);
    border: 1px solid rgba(253,246,236,0.1);
    border-radius: 10px;
    padding: 0.8rem 1rem;
    font-size: 0.85rem;
    color: var(--gris);
    text-align: center;
  }

  /* ========== DASHBOARD ========== */
  #screen-dashboard {
    background: var(--noir);
    min-height: 100vh;
    padding: 1.5rem;
    display: none;
    flex-direction: column;
  }
  #screen-dashboard.active { display: flex; }

  .dash-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(224,123,57,0.2);
  }
  .dash-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    color: var(--orange);
  }
  .dash-count {
    background: rgba(224,123,57,0.15);
    border: 1px solid var(--orange);
    border-radius: 20px;
    padding: 0.3rem 1rem;
    font-size: 0.85rem;
    color: var(--orange);
  }

  /* Stats profils */
  .profil-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.8rem;
    margin-bottom: 1.5rem;
  }
  .stat-card {
    background: rgba(253,246,236,0.05);
    border: 1px solid rgba(224,123,57,0.15);
    border-radius: 14px;
    padding: 1rem;
    text-align: center;
  }
  .stat-emoji { font-size: 1.8rem; display: block; margin-bottom: 0.3rem; }
  .stat-nom { font-size: 0.8rem; color: var(--orange-light); font-weight: 500; margin-bottom: 0.3rem; }
  .stat-nb { font-family: 'Playfair Display', serif; font-size: 1.8rem; color: var(--creme); }

  /* Liste jeunes */
  .jeunes-list { display: flex; flex-direction: column; gap: 0.7rem; flex: 1; overflow-y: auto; }
  .jeune-card {
    background: rgba(253,246,236,0.04);
    border: 1px solid rgba(224,123,57,0.15);
    border-radius: 12px;
    padding: 0.9rem 1.1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: fadeIn 0.4s ease;
  }
  .jeune-info { display: flex; flex-direction: column; gap: 0.2rem; }
  .jeune-nom { font-size: 0.95rem; font-weight: 500; color: var(--creme); }
  .jeune-age { font-size: 0.75rem; color: var(--gris); }
  .jeune-profil {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(224,123,57,0.1);
    border-radius: 20px;
    padding: 0.3rem 0.8rem;
  }
  .jeune-profil-emoji { font-size: 1.1rem; }
  .jeune-profil-nom { font-size: 0.8rem; color: var(--orange-light); }

  .dash-empty {
    text-align: center;
    color: var(--gris);
    font-style: italic;
    padding: 2rem;
    font-size: 0.9rem;
  }

  /* Bouton reset */
  .btn-reset {
    background: transparent;
    border: 1px solid rgba(255,80,80,0.3);
    color: rgba(255,80,80,0.6);
    border-radius: 8px;
    padding: 0.4rem 0.8rem;
    font-size: 0.75rem;
    cursor: pointer;
    margin-top: 1rem;
    align-self: center;
  }
  .btn-reset:hover { border-color: rgba(255,80,80,0.6); color: rgba(255,80,80,0.9); }

  /* Acc√®s dashboard */
  .dash-access {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 100;
  }
  .btn-dash {
    background: rgba(26,16,8,0.9);
    border: 1px solid var(--orange);
    color: var(--orange);
    border-radius: 50px;
    padding: 0.6rem 1.2rem;
    font-size: 0.8rem;
    cursor: pointer;
    backdrop-filter: blur(10px);
  }

  /* Note Firebase */
  .firebase-note {
    background: rgba(74,122,90,0.1);
    border: 1px solid rgba(74,122,90,0.3);
    border-radius: 10px;
    padding: 0.8rem 1rem;
    font-size: 0.8rem;
    color: #8FBF9F;
    text-align: center;
    margin-top: 1rem;
  }

  /* Message intro */
  .intro-text {
    font-size: 0.95rem;
    line-height: 1.7;
    color: var(--creme-dark);
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .nav-buttons {
    display: flex;
    gap: 0.8rem;
    width: 100%;
    max-width: 480px;
    margin-top: 1.5rem;
  }
  .nav-buttons .btn { flex: 1; }

  /* ========== QUESTIONS OUVERTES ========== */
  .question-ouverte textarea {
    width: 100%;
    max-width: 480px;
    background: rgba(253,246,236,0.06);
    border: 1px solid rgba(224,123,57,0.3);
    border-radius: 14px;
    padding: 1.1rem 1.3rem;
    color: var(--creme);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    line-height: 1.6;
    outline: none;
    resize: none;
    min-height: 120px;
    transition: border-color 0.2s;
  }
  .question-ouverte textarea:focus {
    border-color: var(--orange);
    background: rgba(253,246,236,0.09);
  }
  .question-ouverte textarea::placeholder { color: var(--gris); font-style: italic; }
  .char-count {
    font-size: 0.72rem;
    color: var(--gris);
    text-align: right;
    margin-top: 0.4rem;
    max-width: 480px;
  }

  /* R√©ponses libres dans dashboard */
  .jeune-verbatim {
    font-size: 0.82rem;
    color: var(--creme-dark);
    font-style: italic;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(224,123,57,0.1);
    line-height: 1.5;
  }
  .verbatim-label {
    font-size: 0.7rem;
    color: var(--orange);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-style: normal;
    display: block;
    margin-bottom: 0.2rem;
  }

  /* Password dash */
  .pwd-wrap { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
  .pwd-wrap input {
    flex: 1;
    background: rgba(253,246,236,0.08);
    border: 1px solid rgba(224,123,57,0.3);
    border-radius: 10px;
    padding: 0.6rem 1rem;
    color: var(--creme);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    outline: none;
  }
  .pwd-wrap button {
    background: var(--orange);
    border: none;
    border-radius: 10px;
    padding: 0.6rem 1rem;
    color: var(--noir);
    cursor: pointer;
    font-size: 0.9rem;
  }
  .pwd-error { color: #FF6B6B; font-size: 0.8rem; margin-top: 0.4rem; display: none; }
</style>
</head>
<body>

<!-- ========== √âCRAN ACCUEIL ========== -->
<div class="screen active" id="screen-accueil">
  <div class="logo">Fonnk√®r</div>
  <div class="logo-sub">Quiz de cl√¥ture</div>
  <div class="divider"></div>
  <p class="intro-text" style="max-width:400px;">
    Avant de commencer, dis-moi qui tu es.<br>
    Tes r√©ponses resteront entre nous. üå∫
  </p>
  <div class="card">
    <div class="input-group">
      <label>Ton pr√©nom</label>
      <input type="text" id="input-prenom" placeholder="Ex: Ma√´va" autocomplete="off" />
    </div>
    <div class="input-group">
      <label>Ton √¢ge</label>
      <input type="number" id="input-age" placeholder="Ex: 17" min="10" max="99" />
    </div>
    <button class="btn" onclick="demarrer()">C'est parti üåø</button>
  </div>
  <div style="margin-top:2rem;">
    <p style="font-size:0.75rem;color:var(--gris);text-align:center;margin-bottom:0.8rem;">M√©diateur¬∑trice Z√©am ?</p>
    <button class="btn-ghost" style="max-width:300px;margin:0 auto;display:block;" onclick="accederDashboard()">
      <span style="margin-right:0.5rem;">üîê</span> Connexion Google ‚Äî Z√©am
    </button>
    <p class="pwd-error" id="pwd-error">Compte non autoris√©</p>
  </div>
</div>

<!-- ========== √âCRAN QUESTION ========== -->
<div class="screen" id="screen-question">
  <div class="progress-wrap">
    <div class="progress-info">
      <span id="progress-label">Question 1 / 8</span>
      <span id="progress-pct">0%</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
  </div>

  <p class="question-number" id="q-number">Question 1</p>
  <p class="question-text" id="q-text">‚Äî</p>

  <div class="options" id="options-container"></div>

  <div class="nav-buttons">
    <button class="btn-ghost" onclick="precedent()" id="btn-prev" style="display:none">‚Üê Retour</button>
    <button class="btn" onclick="suivant()" id="btn-next" style="opacity:0.4;pointer-events:none;">Suivant ‚Üí</button>
  </div>
</div>

<!-- ========== √âCRAN R√âSULTAT ========== -->
<div class="screen" id="screen-resultat">
  <div class="logo" style="font-size:1.8rem;margin-bottom:0.3rem;">Ton profil Fonnk√®r</div>
  <div class="divider"></div>
  <div class="card" style="max-width:440px;">
    <span class="profil-emoji" id="res-emoji">üåø</span>
    <div class="profil-nom" id="res-nom">‚Äî</div>
    <p class="profil-desc" id="res-desc">‚Äî</p>
    <div class="profil-force" id="res-force">‚Äî</div>
    <div class="profil-etape" id="res-etape">‚Äî</div>
  </div>
  <div style="margin-top:1.5rem;text-align:center;">
    <p style="font-size:0.85rem;color:var(--gris);margin-bottom:1rem;">Merci d'avoir particip√© üå∫</p>
    <button class="btn-ghost" onclick="recommencer()">Recommencer</button>
  </div>
</div>

<!-- ========== DASHBOARD M√âDIATEUR ========== -->
<div class="screen" id="screen-dashboard">
  <div class="dash-header">
    <div class="dash-title">üå∫ Tableau de bord</div>
    <div style="display:flex;align-items:center;gap:0.8rem;">
      <div class="dash-count" id="dash-count">0 jeunes</div>
      <button class="btn-ghost" style="padding:0.3rem 0.8rem;font-size:0.75rem;" onclick="deconnecterDash()" id="btn-deconnexion" title="Se d√©connecter">‚èè</button>
    </div>
  </div>
  <div id="dash-user-info" style="font-size:0.75rem;color:var(--gris);text-align:right;margin-bottom:1rem;margin-top:-0.5rem;"></div>

  <div class="profil-stats" id="profil-stats">
    <div class="stat-card">
      <span class="stat-emoji">üåø</span>
      <div class="stat-nom">L'√âveill√©¬∑e</div>
      <div class="stat-nb" id="stat-eveille">0</div>
    </div>
    <div class="stat-card">
      <span class="stat-emoji">üî•</span>
      <div class="stat-nom">La Voix</div>
      <div class="stat-nb" id="stat-voix">0</div>
    </div>
    <div class="stat-card">
      <span class="stat-emoji">üå∫</span>
      <div class="stat-nom">Le Passeur¬∑se</div>
      <div class="stat-nb" id="stat-passeur">0</div>
    </div>
    <div class="stat-card">
      <span class="stat-emoji">‚ö°</span>
      <div class="stat-nom">Le Cr√©ateur¬∑trice</div>
      <div class="stat-nb" id="stat-createur">0</div>
    </div>
  </div>

  <div class="jeunes-list" id="jeunes-list">
    <div class="dash-empty">En attente des premi√®res r√©ponses...</div>
  </div>

  <div class="firebase-note" id="firebase-status">
    üîÑ Connexion Firebase en cours...
  </div>

  <button class="btn-reset" onclick="resetData()">üóë Effacer toutes les donn√©es</button>
  <button class="btn-ghost" style="margin-top:0.8rem;align-self:center;" onclick="retourAccueil()">‚Üê Retour quiz</button>
</div>

<script>
// ========== DONN√âES ==========

const QUESTIONS = [
  {
    texte: "Avant cet atelier, ta voix c'√©tait...",
    options: [
      { texte: "Quelque chose de flou que je ne comprenais pas moi-m√™me", profil: "eveille" },
      { texte: "Quelque chose de fort mais sans sortie", profil: "voix" },
      { texte: "Quelque chose que je gardais pour moi pour ne pas d√©ranger", profil: "passeur" },
      { texte: "Quelque chose que je ne pensais pas avoir", profil: "createur" }
    ]
  },
  {
    texte: "Ce qui a le plus boug√© en toi pendant l'atelier...",
    options: [
      { texte: "Je commence √† me voir diff√©remment", profil: "eveille" },
      { texte: "Je commence √† croire que mes mots ont du poids", profil: "voix" },
      { texte: "Je me sens moins seul¬∑e dans ma t√™te", profil: "passeur" },
      { texte: "J'ai d√©couvert que je pouvais cr√©er quelque chose", profil: "createur" }
    ]
  },
  {
    texte: "Quand tu √©cris maintenant, tu te sens...",
    options: [
      { texte: "Quelqu'un qui s'observe avec douceur", profil: "eveille" },
      { texte: "Quelqu'un qui a enfin une sortie", profil: "voix" },
      { texte: "Quelqu'un qui rejoint les autres", profil: "passeur" },
      { texte: "Quelqu'un qui invente quelque chose de nouveau", profil: "createur" }
    ]
  },
  {
    texte: "La phrase qui te ressemble le plus aujourd'hui...",
    options: [
      { texte: "Je commence √† nommer ce que je ressens", profil: "eveille" },
      { texte: "Ma parole m√©rite d'√™tre entendue", profil: "voix" },
      { texte: "Je ne suis pas le¬∑la seul¬∑e √† vivre √ßa", profil: "passeur" },
      { texte: "J'ai quelque chose √† offrir que je ne soup√ßonnais pas", profil: "createur" }
    ]
  },
  {
    texte: "Ta prochaine √©tape naturelle, tu la vois comment ?",
    options: [
      { texte: "√âcrire pour moi, explorer mon int√©rieur", profil: "eveille" },
      { texte: "Oser prendre la parole devant les autres", profil: "voix" },
      { texte: "Cr√©er quelque chose avec d'autres", profil: "passeur" },
      { texte: "Lancer un projet qui me tient vraiment √† c≈ìur", profil: "createur" }
    ]
  },
  {
    texte: "Ce que tu emportes de cet atelier...",
    options: [
      { texte: "Une fa√ßon de me regarder avec moins de duret√©", profil: "eveille" },
      { texte: "La certitude que j'ai quelque chose √† dire", profil: "voix" },
      { texte: "Le sentiment de ne plus √™tre seul¬∑e", profil: "passeur" },
      { texte: "Une √©tincelle que je n'avais pas avant", profil: "createur" }
    ]
  },
  {
    texte: "Si quelqu'un te demande ce que Fonnk√®r t'a apport√©, tu dis...",
    options: [
      { texte: "J'ai appris √† m'√©couter", profil: "eveille" },
      { texte: "J'ai trouv√© ma voix", profil: "voix" },
      { texte: "J'ai trouv√© les autres", profil: "passeur" },
      { texte: "J'ai trouv√© ce que je pouvais cr√©er", profil: "createur" }
    ]
  },
  {
    texte: "L'image qui d√©crit le mieux ton chemin dans cet atelier...",
    options: [
      { texte: "Une lumi√®re qui s'allume doucement dans une pi√®ce sombre", profil: "eveille" },
      { texte: "Un feu qu'on avait √©touff√© et qui reprend", profil: "voix" },
      { texte: "Un fil qui relie des gens qui se croyaient seuls", profil: "passeur" },
      { texte: "Une graine qui explose et surprend tout le monde", profil: "createur" }
    ]
  }
];

// ========== QUESTIONS OUVERTES ==========
const QUESTIONS_OUVERTES = [
  {
    id: "moi_avant",
    texte: "Que dirais-tu √† ton moi d'avant l'atelier Fonnk√®r ?",
    placeholder: "√âcris-lui ce que tu voudrais qu'il sache...",
    emoji: "üíå"
  },
  {
    id: "ne_pas_oublier",
    texte: "En quelques mots ou une phrase, qu'est-ce que tu ne veux surtout pas oublier ?",
    placeholder: "Ce qui doit rester grav√©...",
    emoji: "üåø"
  },
  {
    id: "plus_transforme",
    texte: "Dynamique de groupe, cadre bienveillant, jeux d'√©criture, mise en voix... qu'est-ce qui t'a le plus transform√© dans cet atelier ?",
    placeholder: "Ce qui a vraiment chang√© quelque chose pour toi...",
    emoji: "‚ö°"
  }
];

const PROFILS = {
  eveille: {
    emoji: "üåø",
    nom: "L'√âveill√©¬∑e",
    desc: "Tu commences √† te voir. Avant l'atelier, tu fermais parfois les yeux sur ce que tu ressentais. Ce qui a boug√© en toi, c'est la conscience de soi ‚Äî tu commences √† nommer tes √©motions, √† t'observer avec un peu plus de douceur.",
    force: "‚ú® Ta force : l'introspection",
    etape: "‚Üí Ta prochaine √©tape naturelle : l'√©criture pour toi-m√™me"
  },
  voix: {
    emoji: "üî•",
    nom: "La Voix",
    desc: "Tu avais des choses √† dire mais tu ne savais pas comment. L'atelier a d√©verrouill√© quelque chose : tu commences √† croire que tes mots ont du poids, que ta parole m√©rite d'√™tre entendue.",
    force: "‚ú® Ta force : l'expression",
    etape: "‚Üí Ta prochaine √©tape naturelle : oser prendre la parole en public ou dans un collectif"
  },
  passeur: {
    emoji: "üå∫",
    nom: "Le Passeur¬∑se",
    desc: "Tu te sentais parfois seul¬∑e dans ta t√™te. Ce qui a chang√© en toi, c'est le lien ‚Äî tu d√©couvres que tu n'es pas le¬∑la seul¬∑e √† vivre ce que tu vis, et que tu peux te connecter aux autres autrement.",
    force: "‚ú® Ta force : la relation et l'empathie",
    etape: "‚Üí Ta prochaine √©tape naturelle : co-cr√©er quelque chose avec d'autres"
  },
  createur: {
    emoji: "‚ö°",
    nom: "Le Cr√©ateur¬∑trice",
    desc: "Tu ne croyais pas avoir grand chose √† offrir. L'atelier a r√©veill√© une puissance cr√©atrice que tu ne soup√ßonnais pas. Tu as quelque chose √† inventer, √† lancer, √† partager.",
    force: "‚ú® Ta force : l'invention et l'initiative",
    etape: "‚Üí Ta prochaine √©tape naturelle : poursuivre un projet qui te tient vraiment √† c≈ìur"
  }
};

// ========== STATE ==========
let currentQ = 0;
let reponses = [];
let reponsesOuvertes = {};
let modeOuvert = false;
let currentQO = 0;
let prenom = "";
let age = "";
let resultatsFirebase = [];
let dashboardListenerActif = false;

// ========== ATTENTE FIREBASE ==========
function attendreFirebase(callback) {
  if (window._fbReady) { callback(); return; }
  const interval = setInterval(() => {
    if (window._fbReady) { clearInterval(interval); callback(); }
  }, 100);
}

// ========== NAVIGATION ==========
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function demarrer() {
  prenom = document.getElementById('input-prenom').value.trim();
  age = document.getElementById('input-age').value.trim();
  if (!prenom) { document.getElementById('input-prenom').focus(); return; }
  if (!age) { document.getElementById('input-age').focus(); return; }
  currentQ = 0;
  reponses = [];
  reponsesOuvertes = {};
  modeOuvert = false;
  currentQO = 0;
  _profilCalcule = null;
  _scoresCalcules = null;
  afficherQuestion();
  showScreen('screen-question');
}

function accederDashboard() {
  document.getElementById('pwd-error').style.display = 'none';
  attendreFirebase(async () => {
    const ok = await window._connexionGoogle();
    if (ok) {
      if (!dashboardListenerActif) {
        window._startDashboardListener();
        dashboardListenerActif = true;
      }
      mettreAJourHeaderDash();
      afficherDashboard();
      showScreen('screen-dashboard');
    } else {
      document.getElementById('pwd-error').style.display = 'block';
    }
  });
}

function mettreAJourHeaderDash() {
  const user = window._authUser;
  const el = document.getElementById('dash-user-info');
  if (el && user) {
    el.textContent = `üîê Connect√©e : ${user.email}`;
  }
}

async function deconnecterDash() {
  await window._deconnexion();
  dashboardListenerActif = false;
  retourAccueil();
}

function retourAccueil() {
  showScreen('screen-accueil');
}

function recommencer() {
  document.getElementById('input-prenom').value = '';
  document.getElementById('input-age').value = '';
  showScreen('screen-accueil');
}

// ========== QUIZ ==========
function afficherQuestion() {
  const q = QUESTIONS[currentQ];
  const total = QUESTIONS.length;

  document.getElementById('q-number').textContent = `Question ${currentQ + 1}`;
  document.getElementById('q-text').textContent = q.texte;
  document.getElementById('progress-label').textContent = `Question ${currentQ + 1} / ${total}`;
  const pct = Math.round((currentQ / total) * 100);
  document.getElementById('progress-pct').textContent = pct + '%';
  document.getElementById('progress-fill').style.width = pct + '%';

  document.getElementById('btn-prev').style.display = currentQ > 0 ? 'block' : 'none';

  const container = document.getElementById('options-container');
  container.innerHTML = '';
  const lettres = ['A', 'B', 'C', 'D'];

  q.options.forEach((opt, i) => {
    const div = document.createElement('div');
    div.className = 'option' + (reponses[currentQ] === i ? ' selected' : '');
    div.innerHTML = `
      <div class="option-letter">${lettres[i]}</div>
      <div class="option-text">${opt.texte}</div>
    `;
    div.onclick = () => selectionner(i);
    container.appendChild(div);
  });

  const btnNext = document.getElementById('btn-next');
  if (reponses[currentQ] !== undefined) {
    btnNext.style.opacity = '1';
    btnNext.style.pointerEvents = 'auto';
    btnNext.textContent = currentQ < total - 1 ? 'Suivant ‚Üí' : 'Voir mon profil üå∫';
  } else {
    btnNext.style.opacity = '0.4';
    btnNext.style.pointerEvents = 'none';
  }
}

function selectionner(index) {
  reponses[currentQ] = index;
  afficherQuestion();
}

function suivant() {
  if (modeOuvert) {
    suivantOuverte();
    return;
  }
  if (reponses[currentQ] === undefined) return;
  if (currentQ < QUESTIONS.length - 1) {
    currentQ++;
    afficherQuestion();
  } else {
    // Passer aux questions ouvertes
    calculerProfilIntermediaire();
    modeOuvert = true;
    currentQO = 0;
    afficherQuestionOuverte();
    showScreen('screen-question');
  }
}

function precedent() {
  if (modeOuvert) {
    precedentOuverte();
  } else if (currentQ > 0) {
    currentQ--;
    afficherQuestion();
  }
}

// ========== QUESTIONS OUVERTES ==========
function afficherQuestionOuverte() {
  const qo = QUESTIONS_OUVERTES[currentQO];
  const totalFerme = QUESTIONS.length;
  const totalOuvert = QUESTIONS_OUVERTES.length;
  const totalGlobal = totalFerme + totalOuvert;
  const position = totalFerme + currentQO + 1;

  document.getElementById('q-number').textContent = `Question ${position}`;
  document.getElementById('progress-label').textContent = `Question ${position} / ${totalGlobal}`;
  const pct = Math.round(((position - 1) / totalGlobal) * 100);
  document.getElementById('progress-pct').textContent = pct + '%';
  document.getElementById('progress-fill').style.width = pct + '%';

  // Afficher la question ouverte
  document.getElementById('q-text').innerHTML = `${qo.emoji} ${qo.texte}`;
  document.getElementById('btn-prev').style.display = 'block';

  const container = document.getElementById('options-container');
  const valeurActuelle = reponsesOuvertes[qo.id] || '';
  container.innerHTML = `
    <div class="question-ouverte" style="width:100%;max-width:480px;">
      <textarea
        id="textarea-ouverte"
        placeholder="${qo.placeholder}"
        maxlength="400"
        oninput="majCharCount(this)"
      >${valeurActuelle}</textarea>
      <div class="char-count" id="char-count">${valeurActuelle.length}/400</div>
    </div>
  `;

  // Bouton suivant toujours actif (r√©ponse optionnelle)
  const btnNext = document.getElementById('btn-next');
  btnNext.style.opacity = '1';
  btnNext.style.pointerEvents = 'auto';
  const estDerniere = currentQO >= totalOuvert - 1;
  btnNext.textContent = estDerniere ? 'Voir mon profil üå∫' : 'Suivant ‚Üí';
}

function majCharCount(el) {
  const count = document.getElementById('char-count');
  if (count) count.textContent = el.value.length + '/400';
}

function sauvegarderReponseOuverte() {
  const ta = document.getElementById('textarea-ouverte');
  if (ta) {
    const qo = QUESTIONS_OUVERTES[currentQO];
    reponsesOuvertes[qo.id] = ta.value.trim();
  }
}

function suivantOuverte() {
  sauvegarderReponseOuverte();
  if (currentQO < QUESTIONS_OUVERTES.length - 1) {
    currentQO++;
    afficherQuestionOuverte();
  } else {
    calculerProfil();
  }
}

function precedentOuverte() {
  sauvegarderReponseOuverte();
  if (currentQO > 0) {
    currentQO--;
    afficherQuestionOuverte();
  } else {
    // Retour aux questions ferm√©es
    modeOuvert = false;
    currentQ = QUESTIONS.length - 1;
    afficherQuestion();
  }
}

// ========== CALCUL PROFIL (interm√©diaire, sans sauvegarder) ==========
let _profilCalcule = null;
let _scoresCalcules = null;

function calculerProfilIntermediaire() {
  const scores = { eveille: 0, voix: 0, passeur: 0, createur: 0 };
  reponses.forEach((rep, qi) => {
    const profil = QUESTIONS[qi].options[rep].profil;
    scores[profil]++;
  });
  _profilCalcule = Object.entries(scores).sort((a, b) => b[1] - a[1])[0][0];
  _scoresCalcules = scores;
}
function calculerProfil() {
  if (!_profilCalcule) calculerProfilIntermediaire();
  const profil = _profilCalcule;
  const scores = _scoresCalcules;
  const p = PROFILS[profil];

  document.getElementById('res-emoji').textContent = p.emoji;
  document.getElementById('res-nom').textContent = p.nom;
  document.getElementById('res-desc').textContent = p.desc;
  document.getElementById('res-force').textContent = p.force;
  document.getElementById('res-etape').textContent = p.etape;

  // Sauvegarder dans Firebase avec verbatims
  const entry = {
    prenom,
    age,
    profil,
    scores,
    timestamp: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
    date: new Date().toLocaleDateString('fr-FR'),
    verbatims: {
      moi_avant: reponsesOuvertes.moi_avant || '',
      ne_pas_oublier: reponsesOuvertes.ne_pas_oublier || '',
      plus_transforme: reponsesOuvertes.plus_transforme || ''
    }
  };

  attendreFirebase(() => {
    window._sauvegarderFirebase(entry);
  });

  showScreen('screen-resultat');
}

// ========== DASHBOARD ==========
function afficherDashboard() {
  // Utilise les donn√©es Firebase temps r√©el si disponibles
  const liste = window._resultatsFirebase || [];

  // Mise √† jour statut Firebase
  const statusEl = document.getElementById('firebase-status');
  const user = window._authUser;
  if (window._fbReady && user) {
    statusEl.innerHTML = `üü¢ Firebase s√©curis√© ¬∑ connect√©e en tant que ${user.email}`;
    statusEl.style.color = '#8FBF9F';
    statusEl.style.borderColor = 'rgba(74,122,90,0.3)';
  } else {
    statusEl.innerHTML = 'üîÑ Connexion Firebase en cours...';
  }

  // Count
  document.getElementById('dash-count').textContent = `${liste.length} jeune${liste.length > 1 ? 's' : ''}`;

  // Stats profils
  const counts = { eveille: 0, voix: 0, passeur: 0, createur: 0 };
  liste.forEach(r => { if (counts[r.profil] !== undefined) counts[r.profil]++; });
  document.getElementById('stat-eveille').textContent = counts.eveille;
  document.getElementById('stat-voix').textContent = counts.voix;
  document.getElementById('stat-passeur').textContent = counts.passeur;
  document.getElementById('stat-createur').textContent = counts.createur;

  // Liste jeunes
  const list = document.getElementById('jeunes-list');
  if (liste.length === 0) {
    list.innerHTML = '<div class="dash-empty">En attente des premi√®res r√©ponses... üå∫</div>';
    return;
  }

  list.innerHTML = '';
  [...liste].reverse().forEach(r => {
    const p = PROFILS[r.profil] || { emoji: '?', nom: r.profil };
    const v = r.verbatims || {};
    const div = document.createElement('div');
    div.className = 'jeune-card';
    div.style.flexDirection = 'column';
    div.style.alignItems = 'stretch';

    // Header carte
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;align-items:center;justify-content:space-between;';
    header.innerHTML = `
      <div class="jeune-info">
        <div class="jeune-nom">${r.prenom}</div>
        <div class="jeune-age">${r.age} ans ¬∑ ${r.timestamp}</div>
      </div>
      <div class="jeune-profil">
        <span class="jeune-profil-emoji">${p.emoji}</span>
        <span class="jeune-profil-nom">${p.nom}</span>
      </div>
    `;
    div.appendChild(header);

    // Verbatims
    const verbatimsAfficher = [
      { key: 'moi_avant', label: 'üíå √Ä mon moi d\'avant' },
      { key: 'ne_pas_oublier', label: 'üåø √Ä ne pas oublier' },
      { key: 'plus_transforme', label: '‚ö° Ce qui m\'a transform√©' }
    ];
    verbatimsAfficher.forEach(({ key, label }) => {
      if (v[key] && v[key].trim()) {
        const vDiv = document.createElement('div');
        vDiv.className = 'jeune-verbatim';
        vDiv.innerHTML = `<span class="verbatim-label">${label}</span>"${v[key]}"`;
        div.appendChild(vDiv);
      }
    });

    list.appendChild(div);
  });
}

function resetData() {
  if (confirm('Effacer toutes les donn√©es de cet atelier dans Firebase ?')) {
    attendreFirebase(() => {
      window._resetFirebase();
      window._resultatsFirebase = [];
      afficherDashboard();
    });
  }
}

// Mise √† jour statut Firebase au chargement
window.addEventListener('load', () => {
  setTimeout(() => {
    if (window._fbReady) {
      console.log('‚úÖ Firebase pr√™t');
    }
  }, 2000);
});
</script>
</body>
</html>
